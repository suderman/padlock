#!/bin/bash
source "$(cd "$(dirname $(dirname "${BASH_SOURCE[0]}"))" && pwd -P)/bin/config"

# -------------------------------------------
# Revoke Certificate
# -------------------------------------------
NAME="$1"

# Make sure certificate exists
if grep '^V.*'`printf '%q' "/CN=$NAME/"` $CERTIFICATES/db/index; then

  # Revoke the certificate
  openssl ca                                       \
    -revoke  "$CERTIFICATES/certs/$NAME/$NAME.crt" \
    -keyfile  $CERTIFICATES/ca/ca.key              \
    -cert     $CERTIFICATES/ca/ca.crt              \
    -config   $CERTIFICATES/openssl.cnf

  # Regenerate the certificate revocation list
  openssl ca -gencrl                         \
    -keyfile  $CERTIFICATES/ca/ca.key        \
    -cert     $CERTIFICATES/ca/ca.crt        \
    -out      $CERTIFICATES/crl/ca.crl       \
    -config   $CERTIFICATES/openssl.cnf
  openssl crl                                \
    -inform   PEM                            \
    -outform  DER                            \
    -in       $CERTIFICATES/crl/ca.crl.pem   \
    -out      $CERTIFICATES/crl/ca.crl

  # Remove all key/cert files
  rm -rf  "$CERTIFICATES/revoked/$NAME"
  mv "$CERTIFICATES/certs/$NAME" "$CERTIFICATES/revoked/$NAME"

else
  echo "Revoke issue: $NAME doesn't exist."
fi
