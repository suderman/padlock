#!/bin/bash
rm -rf ~/.local/share/shelper.sh
source "$(cd "$(dirname $(dirname "${BASH_SOURCE[0]}"))" && pwd -P)/bin/config"

if hasnt openssl; then
  msg "Please install openssl, ie: sudo apt-get install openssl"
  exit 1;
fi

if hasnt zip; then
  msg "Please install zip, ie: sudo apt-get install zip"
  exit 1;
fi

# Copy configuration and deref variables
copy "$ROOT/openssl.cnf" "$CERTIFICATES/openssl.cnf"
deref "$CERTIFICATES/openssl.cnf"

# Create directory structure
mkdir -p $CERTIFICATES/ca
mkdir -p $CERTIFICATES/db
mkdir -p $CERTIFICATES/certs
mkdir -p $CERTIFICATES/newcerts
mkdir -p $CERTIFICATES/revoked
mkdir -p $CERTIFICATES/crl
mkdir -p $CERTIFICATES/ocsp/requests
mkdir -p $CERTIFICATES/ocsp/responses

# Flat file database
has $CERTIFICATES/db/index || touch $CERTIFICATES/db/index
has $CERTIFICATES/db/serial || echo 1000 > $CERTIFICATES/db/serial
has $CERTIFICATES/crl/crlnumber || echo 1000 > $CERTIFICATES/crl/crlnumber

# -------------------------------------------
# CA Certificate
# -------------------------------------------

# Certificate variables
UNIT="Certificate Authority"
NAME="$CA_NAME"
EMAIL="$CA_EMAIL"

# Generate the certificate authority key
echo "Generate the certificate authority key"
has $CERTIFICATES/ca/ca.key || 
openssl genrsa -out $CERTIFICATES/ca/ca.key 2048 -config $CERTIFICATES/openssl.cnf
chmod 400 $CERTIFICATES/ca/ca.key

# Generate the certificate authority certificate
echo "Generate the certificate authority certificate"
has $CERTIFICATES/ca/ca.crt || 
openssl req -new -x509 -nodes -days 3650 -extensions v3_ca                              \
  -subj "/C=$COUNTRY/ST=$REGION/L=$CITY/O=$ORG/OU=$UNIT/CN=$NAME/emailAddress=$EMAIL/"  \
  -key $CERTIFICATES/ca/ca.key                                                          \
  -out $CERTIFICATES/ca/ca.crt                                                          \
  -config $CERTIFICATES/openssl.cnf


# -------------------------------------------
# OCSP Responder
# -------------------------------------------

# Certificate variables
UNIT="Certificate Authority OCSP"
NAME="$CA_NAME OCSP"
EMAIL="$CA_EMAIL"

# Generate the OCSP key (ocsp.key)
echo "Generate the OCSP key (ocsp.key)"
has $CERTIFICATES/ocsp/ocsp.key || 
openssl genrsa -out $CERTIFICATES/ocsp/ocsp.key 2048 -config $CERTIFICATES/openssl.cnf
chmod 400 $CERTIFICATES/ocsp/ocsp.key

# Generate the OCSP certificate signing request (ocsp.csr)
echo "Generate the OCSP certificate signing request (ocsp.csr)"
has $CERTIFICATES/ocsp/ocsp.crt ||
openssl req -new -extensions v3_OCSP                                                    \
  -subj "/C=$COUNTRY/ST=$REGION/L=$CITY/O=$ORG/OU=$UNIT/CN=$NAME/emailAddress=$EMAIL/"  \
  -key    $CERTIFICATES/ocsp/ocsp.key                                                   \
  -out    $CERTIFICATES/ocsp/ocsp.csr                                                   \
  -config $CERTIFICATES/openssl.cnf

# Sign the request and create the certificate (ocsp.crt)
echo "Sign the request and create the certificate (ocsp.crt)"
has $CERTIFICATES/ocsp/ocsp.crt || 
yes | openssl ca -notext -md sha256 -days 3650 -extensions v3_OCSP \
  -keyfile $CERTIFICATES/ca/ca.key                                 \
  -cert    $CERTIFICATES/ca/ca.crt                                 \
  -in      $CERTIFICATES/ocsp/ocsp.csr                             \
  -out     $CERTIFICATES/ocsp/ocsp.crt                             \
  -config  $CERTIFICATES/openssl.cnf
chmod 444  $CERTIFICATES/ocsp/ocsp.crt
rm -f      $CERTIFICATES/ocsp/ocsp.csr


# -------------------------------------------
# Certificate Revocation List
# -------------------------------------------

# Regenerate the certificate revocation list
echo "Regenerate the certificate revocation list"
openssl ca -gencrl                         \
  -keyfile $CERTIFICATES/ca/ca.key         \
  -cert    $CERTIFICATES/ca/ca.crt         \
  -out     $CERTIFICATES/crl/ca.crl.pem    \
  -config  $CERTIFICATES/openssl.cnf
openssl crl                                \
  -inform  PEM                             \
  -outform DER                             \
  -in      $CERTIFICATES/crl/ca.crl.pem    \
  -out     $CERTIFICATES/crl/ca.crl
